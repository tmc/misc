# Test file watching functionality

# Start server with file watching
md2html -input watch_test.md -v -http :9029 &
sleep 1s

# Initial content check
exec curl -s http://localhost:9029/
stdout 'Initial Content'

# Modify the file to trigger watch
echo '# Modified Content' > watch_test.md
echo 'This file was modified' >> watch_test.md
sleep 2s

# Check that server detected the change
exec curl -s http://localhost:9029/raw
stdout 'Modified Content'

# Test CSS file watching
md2html -input watch_test.md -css watch.css -v -http :9030 &
sleep 1s

# Verify CSS is loaded
exec curl -s http://localhost:9030/
stdout 'color: blue'

# Modify CSS file
echo 'body { color: red; }' > watch.css
sleep 2s

# Test directory watching for new files
md2html -v -http :9031 &
sleep 1s

# Create new markdown file in directory
echo '# New File' > new_file.md
sleep 1s

# Access the new file
exec curl -s http://localhost:9031/new_file
stdout 'New File'

# Clean up
rm watch_test.md watch.css new_file.md

# Clean up background process
wait

-- watch_test.md --
# Initial Content

This file will be modified during the test.

-- watch.css --
body { color: blue; }
.test { font-size: 16px; }