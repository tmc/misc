#!/bin/bash
# recover-goals.sh
set -euo pipefail

git notes --ref=goals list | while read -r commit_hash note_ref; do
    echo "Processing note for commit $commit_hash"
    note_content=$(git cat-file -p "$note_ref" 2>/dev/null)

    # Extract goal description from commit message
    description=$(echo "$note_content" | grep "Goal:" | sed 's/Goal: //')

    if [ -z "$description" ]; then
        echo "No goal found for commit $commit_hash. Skipping."
        continue
    fi

    # Generate a new goal ID
    goal_id=$(date +%Y%m%d%H%M%S)

    # Create new goal metadata
    new_goal_metadata="id: $goal_id
type: goal
description: $description
status: active
created_at: $(date -I)"

    # Update the note with the new metadata
    git notes --ref=goals add -f -m "$new_goal_metadata" $commit_hash

    echo "Recovered goal:"
    echo "$new_goal_metadata"
    echo "---"
done