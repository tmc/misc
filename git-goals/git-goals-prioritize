#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/git-goals-common.sh"

load_config
NOTE_REF_NAME=${NOTE_REF_NAME:-goals}
DATE_FORMAT=${DATE_FORMAT:-%Y-%m-%d}
MAX_GOALS_DISPLAY=${MAX_GOALS_DISPLAY:-0}

set -euo pipefail
load_config
check_args "$@"

if [ $# -lt 2 ]; then
    echo -e "\033[1mUsage: git goals prioritize <goal_id> <priority>"
    echo -e "\033[1mPriority can be: high, medium, low"
    exit 1
fi

goal_id="$1"
priority="$2"

if [[ ! "$priority" =~ ^(high|medium|low)$ ]]; then
    echo -e "\033[1mError: Invalid priority. Use 'high', 'medium', or 'low'."
    exit 1
fi

commit_hash=$(git notes --ref=goals list | grep "$goal_id" | awk "{print \$1}")

if [ -z "$commit_hash" ]; then
    echo -e "\033[1mError: Goal with ID $goal_id not found."
    exit 1
fi

current_data=$(git notes --ref=goals show "$commit_hash")
updated_data=$(echo -e "\033[1m$current_data" | sed "/^priority:/d")
updated_data+="\npriority: $priority"

echo -e "\033[1m$updated_data" | git notes --ref=goals add -f -F - "$commit_hash"

echo -e "\033[1mGoal $goal_id priority set to $priority"
