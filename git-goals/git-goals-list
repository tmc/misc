#!/bin/bash
# git-goals-list - Lists all goals
set -euo pipefail

show_details=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--details)
            show_details=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: git goals list [-d|--details]"
            exit 1
            ;;
    esac
done

echo "Current Goals:"

# Check if there are any notes
if ! git notes --ref=goals list > /dev/null 2>&1; then
    echo "No goals found."
    exit 0
fi

git notes --ref=goals list | while read -r commit_hash note_ref; do
    goal_data=$(git notes --ref=goals show "$commit_hash" 2>/dev/null)

    if [ -z "$goal_data" ]; then
        continue
    fi

    goal_id=$(echo "$goal_data" | grep "^id:" | cut -d' ' -f2)
    description=$(echo "$goal_data" | grep "^description:" | cut -d' ' -f2-)
    status=$(echo "$goal_data" | grep "^status:" | cut -d' ' -f2)

    if $show_details; then
        echo "Goal ID: $goal_id"
        echo "Commit: $commit_hash"
        echo "Status: $status"
        echo "Description: $description"
        echo "$goal_data"
        echo "---"
    else
        short_commit=$(echo $commit_hash | cut -c1-7)
        echo "- $short_commit $goal_id ($status): $description"
    fi
done