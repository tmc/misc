#!/bin/bash
# git-goals-list - Lists all goals
set -euo pipefail

echo "Current Goals:"

# Check if there are any notes
if ! git notes --ref=goals list > /dev/null 2>&1; then
    echo "No goals found."
    exit 0
fi

git notes --ref=goals list | while read -r note_ref commit_hash; do
    goal_data=$(git notes --ref=goals show "$commit_hash" 2>/dev/null)

    # Check if it's the old format (contains 'tree' and 'parent')
    if echo "$goal_data" | grep -q "tree"; then
        description=$(echo "$goal_data" | grep "Goal:" | sed 's/Goal: //')
        if [ -z "$description" ]; then
            echo "Warning: No goal description found for commit $commit_hash"
            continue
        fi
        echo "- $commit_hash (old format): $description"
    else
        goal_id=$(echo "$goal_data" | grep "^id:" | cut -d' ' -f2-)
        description=$(echo "$goal_data" | grep "^description:" | cut -d' ' -f2-)
        status=$(echo "$goal_data" | grep "^status:" | cut -d' ' -f2-)

        if [ -z "$goal_id" ] || [ -z "$description" ] || [ -z "$status" ]; then
            echo "Warning: Incomplete goal data for commit $commit_hash"
            continue
        fi

        echo "- $commit_hash $goal_id ($status): $description"
    fi
done
